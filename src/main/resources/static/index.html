<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>ATM Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        /* ---------- Base from your ATM portal styles, extended for dashboard ---------- */
        :root{
            --glass: rgba(255,255,255,0.07);
            --glass-2: rgba(255,255,255,0.10);
            --accent1: #0066ff;
            --accent2: #002b7f;
        }
        body{
            margin:0; height:100vh; font-family:"Segoe UI",Arial,sans-serif;
            background-image: url("atm-bg.jpg");
            background-size: cover; background-position:center;
            display:flex; gap:20px; align-items:center; justify-content:center;
            color:#fff;
            -webkit-font-smoothing:antialiased;
        }

        /* ===================== VIP ANIMATION ADDED ===================== */
        #vip-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.65);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index: 9999;
            display: none;
            backdrop-filter: blur(10px);
        }

        .vip-box {
            padding: 50px 70px;
            border-radius: 25px;
            background: linear-gradient(145deg,#001b36,#003a7a);
            box-shadow:
                0 0 35px rgba(0,180,255,0.8),
                0 0 80px rgba(0,120,255,0.6),
                inset 0 0 40px rgba(0,150,255,0.5);
            border: 2px solid rgba(0,150,255,0.5);
            animation: vipPop 0.6s ease-out;
        }

        #vip-text {
            font-size: 40px;
            font-weight: 900;
            letter-spacing: 2px;
            color: #00d9ff;
            text-shadow:
                0 0 15px #00d9ff,
                0 0 40px #00b7ff,
                0 0 90px white;
            animation: vipGlow 1.4s infinite alternate;
        }

        @keyframes vipPop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes vipGlow {
            0% { opacity: 0.7; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.15); }
        }
        /* ===================== END VIP ANIMATION ===================== */

        /* App container */
        .app {
            width: 1100px;
            height: 75vh;
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 24px;
            padding: 28px;
            box-sizing: border-box;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(255,255,255,0.03));
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.45), 0 0 20px rgba(0,120,255,0.12);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .brand { font-size:20px; font-weight:700; margin-bottom:18px; text-shadow:0 4px 12px rgba(0,0,0,0.6); }
        .nav { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
        .nav button {
            background:transparent; color:#fff; border:none; text-align:left; padding:12px 14px;
            border-radius:10px; cursor:pointer; font-weight:600;
        }
        .nav button.active { background: linear-gradient(90deg,var(--accent1),var(--accent2)); box-shadow:0 6px 18px rgba(0,0,0,0.5) }
        .small { font-size:13px; opacity:0.85; }

        /* Main panel (glass) */
        .panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
            backdrop-filter: blur(10px);
            border-radius: 18px;
            padding: 26px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 24px rgba(0,120,255,0.06);
            border:1px solid rgba(255,255,255,0.06);
            overflow:auto;
        }
        .top {
            display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px;
        }
        .profile {
            display:flex; gap:12px; align-items:center;
        }
        .avatar {
            width:54px; height:54px; border-radius:12px; background:linear-gradient(135deg,var(--accent1),var(--accent2));
            display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:800;
            box-shadow:0 6px 16px rgba(0,0,0,0.45);
        }
        .welcome { font-size:16px; font-weight:700; }
        .email { font-size:13px; opacity:0.85; margin-top:3px; }

        .cards { display:flex; gap:18px; margin-bottom:22px; }
        .card {
            flex:1;
            background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
            padding:18px; border-radius:12px; min-width:180px;
            border:1px solid rgba(255,255,255,0.04);
        }
        .card h3{ margin:0; font-size:14px; opacity:0.9; }
        .card .big { font-size:26px; font-weight:800; margin-top:10px; }

        .form-row { display:flex; gap:10px; margin-bottom:10px; align-items:center; }
        input[type="text"], input[type="number"], input[type="password"], select {
            padding:12px; border-radius:10px; border:none; outline:none; font-size:15px;
            background: rgba(255,255,255,0.12); color:#fff; flex:1;
        }
        .btn {
            padding:12px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:700;
            background: linear-gradient(145deg,var(--accent1),var(--accent2)); color:#fff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.45);
        }
        .btn.danger { background: linear-gradient(145deg,#e34c37,#a13527); }

        #message { margin-top:10px; padding:12px; border-radius:10px; background:rgba(0,0,0,0.35); font-weight:700; }
        .transactions { margin-top:12px; max-height:220px; overflow:auto; border-top:1px dashed rgba(255,255,255,0.04); padding-top:12px; }
        .tx { display:flex; justify-content:space-between; padding:8px 6px; border-radius:8px; margin-bottom:8px; background:rgba(255,255,255,0.02); }
        .tx .type { font-weight:700; }
        .small-muted { font-size:12px; opacity:0.8; }

        .center-box {
            width:460px; background: rgba(255,255,255,0.07); padding:30px; border-radius:20px; text-align:center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.45), 0 0 22px rgba(0,153,255,0.22);
            border: 1px solid rgba(255,255,255,0.18);
        }
        .center-box h2 { margin:0 0 12px 0; color:#fff; text-shadow:0 3px 8px rgba(0,0,0,0.6); }
        .center-box input { width:86%; padding:12px; margin:10px auto; display:block; border-radius:12px; border:none; background:rgba(255,255,255,0.12); color:#fff; }
        .center-box .btn { width:88%; margin-top:12px; }

        @media (max-width:1180px){
            .app { width: 92vw; grid-template-columns: 220px 1fr; }
        }
        @media (max-width:860px){
            body{ align-items:flex-start; padding:20px }
            .app { grid-template-columns: 1fr; height:auto; width:100%; }
            .sidebar { order:2 }
            .panel { order:1; margin-bottom:18px }
        }
    </style>
</head>
<body>

<div id="vip-overlay">
    <div class="vip-box">
        <span id="vip-text">SUCCESS</span>
    </div>
</div>

<div id="page-root">

    <div id="auth-screen" style="display:flex; align-items:center; justify-content:center; width:100%; height:100vh;">
        <div class="center-box" id="login-box">
            <h2>ATM Portal</h2>

            <div id="auth-tabs" style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">
                <button class="btn" id="tab-login" onclick="showAuth('login')">Login</button>
                <button class="btn" id="tab-create" style="background:transparent; box-shadow:none;" onclick="showAuth('create')">Create</button>
            </div>

            <div id="auth-forms">
                <div id="form-login">
                    <input id="in-card" placeholder="Card Number" />
                    <input id="in-pin" type="password" placeholder="PIN" />
                    <button class="btn" onclick="doLogin()">Login</button>
                </div>

                <div id="form-create" style="display:none">
                    <input id="in-name" placeholder="Full name" />
                    <input id="in-email" placeholder="Email address" />
                    <input id="in-create-card" placeholder="Card Number" />
                    <input id="in-create-pin" type="password" placeholder="PIN" />
                    <input id="in-total" type="number" placeholder="Initial Amount (₹)" />
                    <button class="btn" onclick="doCreate()">Create Account</button>
                </div>
            </div>

            <div id="auth-msg" style="margin-top:12px; color:#fff;"></div>
        </div>
    </div>

    <div id="app-screen" style="display:none; width:100%; height:100vh; align-items:center; justify-content:center;">
        <div class="app">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="brand">MyBank — ATM</div>
                <div class="small">Welcome to your dashboard</div>
                <div class="nav" id="nav">
                    <button id="nav-overview" class="active" onclick="showView('overview')">Overview</button>
                    <button id="nav-actions" onclick="showView('actions')">Quick Actions</button>
                    <button id="nav-history" onclick="showView('history')">Transactions</button>
                    <button id="nav-settings" onclick="showView('settings')">Security</button>
                    <div style="flex:1"></div>
                    <button class="btn danger" onclick="doDeleteAccount()">Delete Account</button>
                    <button class="btn" style="margin-top:8px" onclick="doLogout()">Logout</button>
                </div>
            </div>

            <!-- Main panel -->
            <div class="panel">
                <div class="top">
                    <div class="profile">
                        <div class="avatar" id="avatar">U</div>
                        <div>
                            <div class="welcome" id="welcome">Hello, User</div>
                            <div class="email" id="user-email">you@example.com</div>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div class="small-muted">Card</div>
                        <div style="font-weight:800; font-size:18px" id="card-display">----</div>
                    </div>
                </div>

                <div class="cards">
                    <div class="card">
                        <h3>Available Balance</h3>
                        <div class="big" id="balance">₹0</div>
                        <div class="small-muted" id="balance-note">Last updated: —</div>
                    </div>

                    <div class="card">
                        <h3>Account Info</h3>
                        <div style="margin-top:10px"><span class="small-muted">Email</span><div id="info-email">—</div></div>
                        <div style="margin-top:10px"><span class="small-muted">Total (initial)</span><div id="info-total">—</div></div>
                    </div>
                </div>

                <!-- Views area -->
                <div id="view-area">
                    <!-- Overview -->
                    <div id="view-overview">
                        <h3>Quick Summary</h3>
                        <p class="small-muted">Use the actions panel to deposit, withdraw or update PIN. All sensitive actions are protected by JWT.</p>
                    </div>

                    <!-- Actions -->
                    <div id="view-actions" style="display:none">
                        <h3>Quick Actions</h3>

                        <div style="max-width:640px;">
                            <div class="form-row">
                                <input id="q-amount" type="number" placeholder="Amount (₹)" />
                                <select id="q-type" style="width:180px; border-radius:10px; padding:10px;">
                                    <option value="deposit">Deposit</option>
                                    <option value="withdraw">Withdraw</option>
                                </select>
                                <button class="btn" onclick="doQuickAction()">Go</button>
                            </div>

                            <div style="margin-top:18px; border-top:1px dashed rgba(255,255,255,0.04); padding-top:12px;">
                                <h4>Update PIN</h4>
                                <div class="form-row">
                                    <input id="q-oldpin" type="password" placeholder="Old PIN" />
                                    <input id="q-newpin" type="password" placeholder="New PIN" />
                                    <button class="btn" onclick="doUpdatePin()">Update</button>
                                </div>
                            </div>
                        </div>
                        <div id="message" style="display:none"></div>
                    </div>

                    <!-- History -->
                    <div id="view-history" style="display:none">
                        <h3>Transactions</h3>
                        <div class="transactions" id="tx-list"></div>
                    </div>

                    <!-- Settings -->
                    <div id="view-settings" style="display:none">
                        <h3>Security</h3>
                        <p class="small-muted">You are logged in with JWT.</p>
                        <div style="margin-top:12px">
                            <button class="btn" onclick="copyToken()">Copy JWT</button>
                            <button class="btn" style="margin-left:8px" onclick="revokeLocal()">Clear Token</button>
                        </div>
                        <div style="margin-top:12px" id="token-box" class="small-muted"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    /* ---------- CONFIG ---------- */
    const BASE_URL = "http://localhost:8080/atm";

    /* ---------- VIP ANIMATION FUNCTION ADDED ---------- */
    function showVIP(text) {
        const overlay = document.getElementById("vip-overlay");
        const label = document.getElementById("vip-text");
        label.innerText = text;
        overlay.style.display = "flex";

        setTimeout(() => {
            overlay.style.display = "none";
        }, 1300);
    }
    /* ---------- END VIP FX ---------- */

    let jwtToken = localStorage.getItem('atm_jwt') || null;
    let currentUser = JSON.parse(localStorage.getItem('atm_user') || 'null');
    let transactions = JSON.parse(sessionStorage.getItem('atm_tx') || '[]');

    function showAuth(mode){
        document.getElementById('form-login').style.display = mode==='login' ? 'block' : 'none';
        document.getElementById('form-create').style.display = mode==='create' ? 'block' : 'none';
        document.getElementById('tab-login').style.background = mode==='login' ? '' : 'transparent';
    }
    function showMessage(msg, timeout=3500){
        const el = document.getElementById('auth-msg');
        el.innerText = msg;
        setTimeout(()=> el.innerText = '', timeout);
    }
    function showView(name){
        ['overview','actions','history','settings'].forEach(v=>{
            document.getElementById('view-'+v).style.display = (v===name) ? 'block' : 'none';
            const btn = document.getElementById('nav-'+v);
            if(btn) btn.classList.toggle('active', v===name);
        });
        if(name==='history') renderTransactions();
        if(name==='settings') renderToken();
    }

    function doCreate(){
        const name = document.getElementById('in-name').value.trim();
        const email = document.getElementById('in-email').value.trim();
        const card = document.getElementById('in-create-card').value.trim();
        const pin = document.getElementById('in-create-pin').value.trim();
        const total = Number(document.getElementById('in-total').value || 0);

        if(!name||!email||!card||!pin||!total){ showMessage('All fields required'); return; }

        fetch(BASE_URL + '/create', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ name, email, cardnumber: card, pinnumber: pin, totalamount: total })
        })
        .then(async r => {
            const text = await r.text();
            if(r.ok){
                showMessage('Account created. Now login.');
                document.getElementById('in-card').value = card;
                showAuth('login');
            } else {
                showMessage(text || 'Create failed');
            }
        })
        .catch(err => showMessage('Network error'));
    }

    function doLogin(){
        const card = document.getElementById('in-card').value.trim();
        const pin = document.getElementById('in-pin').value.trim();
        if(!card||!pin){ showMessage('Card & PIN required'); return; }

        fetch(BASE_URL + '/login', {
            method:'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ loginCardnumber: card, loginPin: pin })
        })
        .then(async r => {
            if(r.status === 200){
                const data = await r.json();
                if(data.token){
                    jwtToken = data.token;
                    currentUser = data.user || { cardnumber: card };
                    localStorage.setItem('atm_jwt', jwtToken);
                    localStorage.setItem('atm_user', JSON.stringify(currentUser));

                    showVIP("LOGIN SUCCESS");  /* ADDED */

                    openDashboard();
                } else {
                    showMessage('Login failed');
                }
            } else {
                const txt = await r.text();
                showMessage(txt || 'Invalid credentials');
            }
        })
        .catch(()=> showMessage('Network error'));
    }

    function openDashboard(){
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'flex';
        renderProfile();
        showView('overview');
    }

    function renderProfile(){
        const user = currentUser || {};
        document.getElementById('welcome').innerText = user.name ? `Hello, ${user.name}` : 'Hello, User';
        document.getElementById('user-email').innerText = user.email || '';
        document.getElementById('avatar').innerText = (user.name || 'U').charAt(0).toUpperCase();
        document.getElementById('card-display').innerText = user.cardnumber || '----';
        document.getElementById('info-email').innerText = user.email || '—';
        document.getElementById('info-total').innerText = user.totalamount ? '₹' + user.totalamount : '—';
        updateBalanceFromUser();
    }

    function updateBalanceFromUser(){
        const bal = currentUser && currentUser.remainingamount
            ? currentUser.remainingamount
            : (currentUser.totalamount || 0);
        document.getElementById('balance').innerText = '₹' + bal;
        document.getElementById('balance-note').innerText = 'Last updated: ' + new Date().toLocaleString();
    }

    function pushTx(type, amount){
        const tx = { type, amount, time: new Date().toISOString() };
        transactions.unshift(tx);
        sessionStorage.setItem('atm_tx', JSON.stringify(transactions.slice(0,200)));
        renderTransactions();
    }

    function renderTransactions(){
        const list = document.getElementById('tx-list');
        list.innerHTML = transactions.length ? '' : '<div class="small-muted">No transactions yet.</div>';
        transactions.forEach(t=>{
            const el = document.createElement('div');
            el.className = 'tx';
            el.innerHTML = `
                <div>
                    <div class="type">${t.type}</div>
                    <div class="small-muted">${new Date(t.time).toLocaleString()}</div>
                </div>
                <div>₹${t.amount}</div>
            `;
            list.appendChild(el);
        });
    }

    function doQuickAction(){
        const amt = Number(document.getElementById('q-amount').value || 0);
        const type = document.getElementById('q-type').value;
        if(!amt || amt <= 0){ alert('Enter valid amount'); return; }
        if(type==='deposit') doDeposit(amt); else doWithdraw(amt);
    }

    function doDeposit(amount){
        fetch(BASE_URL + '/deposit', {
            method:'POST',
            headers: {
                'Content-Type':'application/json',
                'Authorization': 'Bearer ' + jwtToken
            },
            body: JSON.stringify({
                amountCardnumber: currentUser.cardnumber,
                amount
            })
        })
        .then(async r=>{
            const text = await r.text();
            if(r.ok){
                try { currentUser = JSON.parse(text); }
                catch(e){
                    const m = text.match(/([0-9]+)\s*$/);
                    currentUser.remainingamount = m ? Number(m[1]) :
                        (currentUser.remainingamount || 0) + amount;
                }

                localStorage.setItem("atm_user", JSON.stringify(currentUser));
                updateBalanceFromUser();
                pushTx("DEPOSIT", amount);

                showVIP("DEPOSIT SUCCESS"); /* ADDED */

                alert(text);
            } else {
                alert(text || "Deposit failed");
            }
        });
    }

    function doWithdraw(amount){
        fetch(BASE_URL + '/withdraw', {
            method:'POST',
            headers: {
                'Content-Type':'application/json',
                'Authorization': 'Bearer ' + jwtToken
            },
            body: JSON.stringify({
                amountCardnumber: currentUser.cardnumber,
                amount
            })
        })
        .then(async r=>{
            const text = await r.text();
            if(r.ok){
                const m = text.match(/([0-9]+)\s*$/);
                currentUser.remainingamount = m ? Number(m[1]) :
                    Math.max((currentUser.remainingamount || 0) - amount, 0);

                localStorage.setItem("atm_user", JSON.stringify(currentUser));
                updateBalanceFromUser();
                pushTx("WITHDRAW", amount);

                showVIP("WITHDRAW SUCCESS"); /* ADDED */

                alert(text);
            } else {
                alert(text || "Withdraw failed");
            }
        });
    }

    function doUpdatePin(){
        const oldPin = document.getElementById('q-oldpin').value.trim();
        const newPin = document.getElementById('q-newpin').value.trim();
        if(!oldPin || !newPin){ alert('Both pins required'); return; }

        fetch(BASE_URL + '/update-pin', {
            method:'POST',
            headers: {
                'Content-Type':'application/json',
                'Authorization': 'Bearer ' + jwtToken
            },
            body: JSON.stringify({
                updateCardnumber: currentUser.cardnumber,
                oldPin, newPin
            })
        })
        .then(async r=> alert(await r.text()));
    }

    function doDeleteAccount(){
        if(!confirm('Are you sure?')) return;

        fetch(BASE_URL + '/delete', {
            method:'DELETE',
            headers:{
                'Content-Type':'application/json',
                'Authorization':'Bearer ' + jwtToken
            },
            body: JSON.stringify({ cardnumber: currentUser.cardnumber })
        })
        .then(async r=>{
            const t = await r.text();
            if(r.ok){
                alert("Account deleted");
                clearSessionAndReturn();
            } else alert(t);
        });
    }

    function doLogout(){ clearSessionAndReturn(); }

    function clearSessionAndReturn(){
        localStorage.removeItem('atm_jwt');
        localStorage.removeItem('atm_user');
        sessionStorage.removeItem('atm_tx');
        window.location.reload();
    }

    function copyToken(){
        if(!jwtToken){ alert('No token'); return; }
        navigator.clipboard.writeText(jwtToken).then(()=> alert('Token copied'));
    }
    function revokeLocal(){
        localStorage.removeItem('atm_jwt');
        jwtToken = null;
        renderToken();
        alert('Token cleared locally');
    }
    function renderToken(){
        const el = document.getElementById('token-box');
        el.innerText = jwtToken || '(no token stored)';
    }

    window.addEventListener('load', ()=>{
        if(jwtToken && currentUser){
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            renderProfile();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-screen').style.display = 'none';
        }
    });
</script>

</body>
</html>
